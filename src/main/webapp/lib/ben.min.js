var Ben=new Ben();function Ben(){console.debug("------------------------");console.debug("Ben.js: Version 0.0.4");console.debug("------------------------");var a=this;this._controllers=new Array();this._templates=new Array();this._routes=new Array();this.createController=function(f,d,c,e){console.debug("register new controller: '"+f+"'");var b=new BenController(f,d,c,e);a._controllers.push(b);if(e){return e}else{return b}};this.createRoute=function(c,d){console.debug("register new route: '"+c+"'");var b=new BenRouter(c,d);a._routes.push(b);return b};this.createTemplate=function(d,b){console.debug("register new template: '"+d+"' view='"+b+"'");var c=new BenTemplate(d,b);a._templates.push(c);return c};this.findControllerByID=function(c){var b;$.each(Ben._controllers,function(d,e){if(e.id==c){b=e;return false}});if(b){return b}else{console.log("ERROR: Controler '"+c+"' not registered")}};this.findTemplateByID=function(c){var b;$.each(Ben._templates,function(d,e){if(e.id==c){b=e;return false}});if(b){return b}else{console.log("ERROR: Template'"+c+"' not registered")}}}function BenController(id,model,view,controller){var that=this;this.id=id;this.model=model;this.view=view;this.controller=controller;this.init=function(context){var selectorId="[ben-controller='"+this.id+"']";if($(selectorId,context).length){console.debug("controller: '"+this.id+"' init...");if(that.view){that.load(that.view,context)}else{that.push(context)}}};this.push=function(context){var selectorId="[ben-controller='"+this.id+"']";$(selectorId,context).each(function(){console.debug("controller: '"+that.id+"' -> push model=",that.model);_update_section(this,that.model,that);$(this).find("[ben-for-each]").each(function(){var modelField=$(this).attr("ben-for-each");var forEachBlock=$(this);var forEachBlockContent=forEachBlock.clone().html().trim();if(!forEachBlockContent.match("^<")){forEachBlockContent="<span>"+forEachBlockContent+"</span>"}$(this).empty();if(modelField){if(!modelField.match("^model.")){modelField="model."+modelField}var modelValue;try{modelValue=eval(modelField)}catch(err){}if($.isArray(modelValue)){$.each(modelValue,function(index,model_element){var newEntry=$.parseHTML(forEachBlockContent);var entryBlock=$(forEachBlock).append(newEntry);_update_section(newEntry,model_element,that)})}}})})};this.pull=function(){var selectorId="[ben-controller='"+this.id+"']";_read_section(selectorId,this.model);console.debug("pull model from view '"+this.id+"': Model=",this.model)};this.load=function(url,searchcontext){if(!url){if(that.view){url=that.view}}if(url){var selectorId="[ben-controller='"+this.id+"']";$(selectorId,searchcontext).each(function(){console.debug("controller: '"+that.id+"' -> load '"+url+"'...");var context=$(this).parent();$(this).load(url,function(response,status,xhr){if(status=="error"){$(this).prepend("<!-- WARNING controller-view '"+url+"' not found -->");console.debug("controller-view '"+url+"' not found!");that.push(context)}else{that.push(context)}})})}}}function BenTemplate(c,a){var b=this;this.id=c;this.url=a;this.beforeLoad=$.Callbacks();this.afterLoad=$.Callbacks();this.load=function(e){if(!b.url){return false}var d="[ben-template='"+b.id+"']";$(d,e).each(function(){console.debug("template: '"+b.id+"' -> load '"+b.url+"'...");b.beforeLoad.fire(b,$(this));$(this).load(b.url,function(g,f,j){var i=$(this);if(f=="error"){var h="template: '"+b.url+"' not found";console.debug(h);$(this).prepend("<!-- WARNING "+h+" -->")}else{console.debug("template: '"+b.url+"' loaded");$(i).find("[ben-controller]").each(function(){var k=Ben.findControllerByID($(this).attr("ben-controller"));if(k){k.init(i)}})}b.afterLoad.fire(b,$(i))})})}}function BenRouter(c,a){var b=this;this.id=c;this.config=a;this.beforeRoute=$.Callbacks();this.afterRoute=$.Callbacks();this.templateCount=0;this.route=function(){console.debug("route: '"+b.id+"'...");b.beforeRoute.fire(b);var d=Object.keys(b.config);$.each(d,function(e,f){var g=Ben.findTemplateByID(f);if(g){g.url=b.config[f];g.afterLoad.add(b._templateOnLoad);b.templateCount++;g.load()}})};this._templateOnLoad=function(d){console.debug("Router: template meldet load finished");d.afterLoad.remove(b._templateOnLoad);b.templateCount--;if(b.templateCount==0){document.location.href="#"+b.id;console.debug("Router: complete");b.afterRoute.fire(b)}}}function _update_section(selector,model,controller){$(selector).find("[ben-model]").each(function(){if($(this).parent("[ben-for-each]").length){return false}var modelField=$(this).attr("ben-model");if(modelField){var modelValue;if(modelField.indexOf("(")>-1){try{modelValue=eval("controller.model."+modelField)}catch(err){console.debug("Error evaluating '"+modelField+"' = "+err.message)}}else{if(!modelField.match("^model.")){modelField="model."+modelField}try{modelValue=eval(modelField)}catch(err){console.debug("Error evaluating '"+modelField+"' = "+err.message)}}if(!modelValue){modelValue=""}if(!this.type&&$(this).text){$(this).text(modelValue)}else{switch(this.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":$(this).val(modelValue);break;case"checkbox":case"radio":this.checked=false}}}})}function _read_section(b,a){$(b).find(":input").each(function(){var d=$(this).attr("ben-model");if(d){var c="";switch(this.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":c=$(this).val();a[d]=c;break;case"checkbox":case"radio":this.checked=false}}})}$(document).ready(function(){console.debug("starting application...");$.each(Ben._controllers,function(a,b){b.init()});$.each(Ben._templates,function(a,b){b.load()})});