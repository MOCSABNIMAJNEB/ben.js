"use strict";var BENJS=BENJS||{};BENJS.namespace=function(d){var c=d.split("."),b=BENJS,a;if(c[0]==="BENJS"){c=c.slice(1)}for(a=0;a<c.length;a+=1){if(typeof b[c[a]]==="undefined"){b[c[a]]={}}b=b[c[a]]}return b};BENJS.namespace("org.benjs.core");BENJS.org.benjs.core=(function(){console.debug("------------------------");console.debug("Ben.js: Version 0.4.0");console.debug("------------------------");var d,h=new Array(),q=new Array(),g=new Array(),m=function(t){t=t||{};if(!t.id){console.error("createController wrong settings provided: id missing!");return false}console.debug("register new controller: '"+t.id+"'");var s=new b(t);h.push(s);return s},j=function(t){t=t||{};if(!t.id){console.error("createTemplate wrong settings provided: id missing!");return false}console.debug("register new template: '"+t.id+"' view='"+t.url+"'");var s=new o(t);q.push(s);return s},f=function(t){t=t||{};if(!t.id){console.error("createController wrong settings provided: id missing!");return false}console.debug("register new route: '"+t.id+"'");var s=new i(t);g.push(s);return s},k=function(t){var s;$.each(h,function(u,v){if(v.id===t){s=v;return false}});if(s){return s}else{console.error("ERROR: Controler '"+t+"' not registered")}},a=function(t){var s;$.each(q,function(u,v){if(v.id===t){s=v;return false}});if(s){return s}else{console.error("ERROR: Template'"+t+"' not registered")}},p=function(t,s){$(t).find(":input").each(function(){var v,w,u;w=$(this).attr("data-ben-model");if(w){w=w.trim();v="";switch(this.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":v=$(this).val();break;case"checkbox":case"radio":this.checked=false}if(w.match("^get[_a-zA-Z0-9.]+\\(")){try{w="set"+w.substring(3);u=w.substring(0,w.indexOf("("));if($.isFunction(s[u])){r(w,s,v)}else{console.warn("setter method '"+u+"' is not defined!")}}catch(x){console.error("Error calling setter-method '"+w+"' -> "+x.message)}}else{s[w]=v}}})},l=function(s){if(d.appVersion){if(s.indexOf("?")>-1){s=s+"&appVersion="+d.appVersion}else{s=s+"?appVersion="+d.appVersion}}return s},r=function(x,t,u){var v,B,z,y,A,s,w;v=x.indexOf("(");B=x.substring(0,v);z=x.substring(v+1).trim();z=z.substring(0,z.indexOf(")")).trim();y=z.split(",");if(u){y.push(u)}$.each(y,function(C,D){if(D.indexOf("'")===0||D.indexOf('"')===0){y[C]=D.substring(1,D.length-1)}else{}});s=B.split(".");B=s.pop();for(w=0;w<s.length;w++){t=t[s[w]]}A=t[B];if(typeof A==="function"){return A.apply(t,y)}},e=function(u,x){var t,w,v,s;t=window;w=u.split(".");v=w.pop();for(s=0;s<w.length;s++){t=t[w[s]]}return new t[v](x)},c=function(){if(d===undefined){n()}console.debug("starting application...");$.each(h,function(s,t){t.init()});if(d.loadTemplatesOnStartup){$.each(q,function(s,t){t.load()})}},n=function(s){console.debug("init application...");if(s===undefined){d={}}else{d=s}if(d.loadTemplatesOnStartup===undefined){d.loadTemplatesOnStartup=true}if(d.appVersion===undefined){d.appVersion=""}console.debug("configuration=",d)},b=function(s){s=s||{};var t=this;this.id=s.id;this.model=s.model;this.view=s.view;if(typeof s.autoRefresh=="undefined"){this.autoRefresh=true}else{this.autoRefresh=s.autoRefresh}this.foreachCache=new Array();this.beforePush=$.Callbacks();this.afterPush=$.Callbacks();this.beforePull=$.Callbacks();this.afterPull=$.Callbacks();if(typeof s.beforePush==="function"){this.beforePush.add(s.beforePush)}if(typeof s.afterPush==="function"){this.afterPush.add(s.afterPush)}if(typeof s.beforePull==="function"){this.beforePull.add(s.beforePull)}if(typeof s.afterPull==="function"){this.afterPull.add(s.afterPull)}this.init=function(v){this.foreachCache=new Array();var u="[data-ben-controller='"+this.id+"']";if($(u,v).length){console.debug("controller: '"+this.id+"' init...");if(t.view){t.load(t.view,v)}else{t.push(v)}}};this.push=function(w){var v="[data-ben-controller='"+this.id+"']",u=$(v,w);console.debug("controller: '"+t.id+"' -> push model=",t.model);t.beforePush.fire(t,u);$(u).each(function(){t._update(this,t.model)});t.afterPush.fire(t,u)};this.pull=function(){var v="[data-ben-controller='"+this.id+"']",u=$(v);t.beforePull.fire(t,u);p(v,this.model);console.debug("pull model from view '"+this.id+"': Model=",this.model);t.afterPull.fire(t,u)};this.refresh=function(u){t.pull();t.push()};this.load=function(u,w){this.foreachCache=new Array();if(!u){if(t.view){u=t.view}}if(u){var v="[data-ben-controller='"+this.id+"']";u=l(u);$(v,w).each(function(){console.debug("controller: '"+t.id+"' -> load '"+u+"'...");var x=$(this).parent();$(this).load(u,function(z,y,A){if(y==="error"){$(this).prepend("<!-- WARNING controller-view '"+u+"' not found -->");console.debug("controller-view '"+u+"' not found!");t.push(x)}else{t.push(x)}})})}};this._update=function(u,v){$(u).find("[data-ben-render]").each(function(){var x,w,y;x=$(this).attr("data-ben-render");w=$(this).closest("[data-ben-foreach]");y=$(u).closest("[data-ben-foreach]");if(w.length===0||$(w).get(0)===$(y).get(0)){t._render_element(this,x,v)}else{}});$(u).find("[data-ben-foreach]").each(function(){var w;w=$(this).attr("data-ben-foreach-id");if(!w){w=t.foreachCache.length;$(this).attr("data-ben-foreach-id",w);t.foreachCache.push("")}});$(u).find("[data-ben-model]").each(function(){var x,w,y;x=$(this).attr("data-ben-model");w=$(this).closest("[data-ben-foreach]");y=$(u).closest("[data-ben-foreach]");if(w.length===0||$(w).get(0)===$(y).get(0)){t._update_element(this,x,v)}else{}});$(u).find("[data-ben-foreach]").each(function(){var C,z,x,D,w,y,B,A;z=$(this).attr("data-ben-foreach");x=$(this).attr("data-ben-foreach-id");if(z.indexOf(" as ")>-1){B=z.split(" ");z=B[0].trim();A=B[2].trim()}C=$(this).parent("[data-ben-foreach]");D=t._extract_model_value(z,v);if(C.length===0&&D&&$.isArray(D)){w=$(this);if(x){if(x>=t.foreachCache.length){console.debug("WARNING - wrong foreachCach length!")}y=t.foreachCache[x]}if(!y){console.debug("caching foreach block: "+x);y=w.clone().html().trim();if(y.indexOf("<")!=0||!$(y).html()){y="<span>"+y+"</span>"}t.foreachCache[x]=y}$(this).empty();if($.isArray(D)){$.each(D,function(E,F){var G;if(A){F=e(A,F)}G=$.parseHTML(y);$(G).attr("data-ben-entry",E);$(w).append(G);t._update(G,F)})}}})};this._update_element=function(u,y,x){var z,w,v;if(y){if(y.match("^::")){w=y.indexOf("::",2);z=y.substring(2,w);y=y.substring(w+2)}v=t._extract_model_value(y,x);if(z){$(u).attr(z,v)}else{if(!u.type&&$(u).text){$(u).html(v)}else{switch(u.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":$(u).val(v);break;case"checkbox":case"radio":$(u).checked=false}}}}};this._render_element=function(u,x,w){var v;if(x){v=t._extract_model_value(x,w);if(v){$(u).show()}else{$(u).hide()}}};this._extract_model_value=function(x,w){var v,u;if(x){x=x.trim();if(x.indexOf("(")>-1){if(x.match("^[_a-zA-Z0-9.]+\\(")){try{u=x.substring(0,x.indexOf("("));v=r(x,w)}catch(y){console.error("Error calling gettermethod '"+x+"' -> "+y.message)}}else{console.error("Error invalid method call -> "+x)}}else{if(x==="."){v=w}else{v=w[x]}}if((typeof(v)==="undefined")){v=""}return v}}},o=function(s){s=s||{};var t=this;this.id=s.id;this.url=s.url;this.beforeLoad=$.Callbacks();this.afterLoad=$.Callbacks();if(typeof s.beforeLoad==="function"){this.beforeLoad.add(s.beforeLoad)}if(typeof s.afterLoad==="function"){this.afterLoad.add(s.afterLoad)}this.load=function(u){if(u){t.url=u}if(!t.url){console.debug("Warning: temlate '"+t.id+"' can't be loaded: no url defined!");return false}var v="[data-ben-template='"+t.id+"']";t.url=l(t.url);$(v).each(function(){console.debug("template: '"+t.id+"' -> load '"+t.url+"'...");t.beforeLoad.fire(t,$(this));$(this).load(t.url,function(x,w,A){var y,z=$(this);if(w==="error"){y="Error loading template '"+t.url+"': not found";console.error(y);$(this).prepend("<!-- "+y+" -->")}else{console.debug("template: '"+t.id+"' loaded");$(z).find("[data-ben-controller]").each(function(){var B=BENJS.org.benjs.core.findControllerByID($(this).attr("data-ben-controller"));if(B&&B.autoRefresh===true){B.init(z)}})}t.afterLoad.fire(t,$(z))})})}},i=function(s){s=s||{};var t=this;this.id=s.id;this.templates=s.templates;this.beforeRoute=$.Callbacks();this.afterRoute=$.Callbacks();this.templateCount=0;if(typeof s.beforeRoute==="function"){this.beforeRoute.add(s.beforeRoute)}if(typeof s.afterRoute==="function"){this.afterRoute.add(s.afterRoute)}this.route=function(){console.debug("route: '"+t.id+"'...");t.beforeRoute.fire(t);var u=Object.keys(t.templates);$.each(u,function(v,w){var x=BENJS.org.benjs.core.findTemplateByID(w);if(x){t.templateCount++;x.afterLoad.add(t._templateOnLoad);x.load(t.templates[w],false)}})};this._templateOnLoad=function(u){u.afterLoad.remove(t._templateOnLoad);t.templateCount--;if(t.templateCount===0){document.location.href="#"+t.id;console.debug("route: '"+t.id+"' complete");t.afterRoute.fire(t)}}};return{start:c,init:n,createController:m,createTemplate:j,createRoute:f,findControllerByID:k,findTemplateByID:a}}());$(document).ready(function(){BENJS.org.benjs.core.start()});